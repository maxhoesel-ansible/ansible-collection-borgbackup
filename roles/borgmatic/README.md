# maxhoesel.borgbackup.borgmatic

Install borg+borgmatic and setup a system backup job.

This role installs borg and [borgmatic](https://torsion.org/borgmatic/) (a configuration-driven wrapper around borg),
then optionally sets up a scheduled backup job. More specifically, this role will:

- Create a custom borgmatic configuration based on simple Ansible variables
- Manage the SSH client keys and known_hosts file for you
- Setup a schedule using a systemd timer
- And more! See the role variables below

## Requirements

- The following distributions are currently supported:
  - Ubuntu 20.04 LTS or newer
  - There are no plans to support CentOS/RHEL-based distros right now
- This role requires root access. Make sure to run this role with `become: yes` or equivalent

## Role Variables

### Limit executed Components

To limit execution of this role to specific components, use the variables below.
By default, all components are executed.

| Variable | Component/Description | Notes |
|-----------|----------|-------|
| `borgmatic_install` | Installation of borg + borgmatic |  |
| `borgmatic_setup_backup` | Configuration of the backup job/environment | Disabling this variable will cause all steps below to be skipped.
| `borgmatic_init_repos` | Initialization of repositories defined in `borgmatic_location_repositories`, both remote and local
| `borgmatic_ssh_manage_key` | Management of a client SSH key for borgmatic (see [below](#ssh-management)) |
| `borgmatic_ssh_manage_known_hosts` | Management of the borgmatic-specific known_hosts file |
| `borgmatic_manage_config` | Generation of the borgmatic config file |
| `borgmatic_manage_schedule` | Generation and configuration of the systemd timer + service used for regular backups | Disabling this variable will also disable the check job
| `borgmatic_schedule_check_job` | Generation of a separate job for running backup repo checks |

### General

##### `borgmatic_config_path`
- Path in which the borgmatic config should be saved
- Only has an effect if `borgmatic_setup_backup` is set to `true`
- Default: `/etc/borgmatic`

##### `borgmatic_init_encryption`
- Encryption mode to use when initializing the repositories
- Default: `repokey`

##### `borgmatic_run_backup`
- Schedule a backup job when this role finishes execution
- Note that enabling this will cause the role be non-idempotent (it will report changed tasks on every run)
- Default: `false`

### SSH Management

If you are backing up to a remote host via SSH, this role can manage the client ssh key and known_hosts file for you.

This role always executes backups as the root user, but it uses its own ssh user configuration as to
not interfere with other processes on the system running as root.
You can disable this behavior if you want to use the default root ssh settings.

##### `borgmatic_ssh_manage_key`
- If set to `true`, the role will setup borg to use a custom ssh key found at `{{ borgmatic_ssh_key_path }}`.
  - If no key is present, a new key will automatically be generated
- If set to `false`, no key will be generated and borgmatic will use the default root ssh key
- Default: `true`

##### `borgmatic_ssh_key_path`
- Path under which the custom ssh key is saved.
- You can set this to an already existing ssh key if you don't want to use the one generated by this role
- Default: `{{ borgmatic_config_path }}/id_rsa`

##### `borgmatic_ssh_manage_known_hosts`
- If set to `true`, the role will create and populate a borgmatic-specific known_hosts file with all remote backup server ssh fingerprints
  - Note that the remote servers need to be online for this to function properly
- If set to `false`, borgmatic will use the default root known_hosts file instead. This may cause the backup job to fail due to host authentication failures.
- Default: `true`

##### `borgmatic_ssh_known_hosts_file`
- Path under which the custom known_hosts file will be saved
- You can set this to an existing known_hosts file if you don't want to use the one generated by this role
- Default: `{{ borgmatic_config_path }}/known_hosts`

### Backup settings

This role supports all borgmatic configuration parameters as variables.

The following settings correspond to the configuration options for [borgmatic](https://torsion.org/borgmatic/docs/reference/configuration/).
See the official page for more details. These parameters are templated out into the borgmatic config, so borg placeholders and the like should work.

Aside from the required parameters that are passed to this role (see below), *all other parameters are optional and left undefined by default.*. This means that unless you specify them, borgmatic will just use its internal defaults for these values.

The format for variable names is: `borgmatic_{section}_{parameter}`. For example, a borgmatic configuration like this:

```yaml
location:
  source_directories:
    - /home
    - /etc
    - /var
storage:
  encryption_passcommand: secret-tool lookup borg-repository repo-name
```

can be represented like so:

```yaml
borgmatic_location_source_directories:
  - /home
  - /etc
  - /var
borgmatic_storage_encryption_passcomand: secret-tool lookup borg-repository repo-name

```

The following parameters are either required or need extra attention:

| Name | Description | Required | Default |
|------|-------------|:--------:|---------|
| `location_source_directories` | List of directories to backup | X | `["/etc", "/home", "/var"]` |
| `location_repositories` | Paths to target repositories, local or remote | X | undefined |
| `storage_encryption_passphrase` | Passphrase with which to encrypt the repository | If `borgmatic_init_repos` is set to `true` | undefined
| `retention_keep_*` | At least one `keep_` parameter is required for retention to work properly | X | undefined
| `storage_ssh_command` | See the [About ssh_command and custom parameters](#about-ssh-command-and-custom-parameters) section for more details | | undefined if `borgmatic_ssh_manage_key` and `borgmatic_ssh_manage_known_hosts` are false |
| `consistency_checks` | If you are using the [separate timer for check jobs](#scheduling-the-separate-check-job) due to performance reasons you probably want to set this to `['disabled']` | | undefined |

### Schedule settings

These variables control the systemd timer and service used to run borgmatic periodically.
Note that these values (except for `backup_time`) also affect the separate check jobs.

The prefix for all variables in this section is: `borgmatic_schedule_`
| Name | Description | Required | Default |
|------|-------------|:--------:|---------|
| `backup_time` | Schedule at which the backup should be run. Can be any valid [systemd time expression](https://www.freedesktop.org/software/systemd/man/systemd.time.html#). | X | `daily` |
| `max_random_delay` | To prevent several hosts pegging your backup server at once, systemd can delay execution within a random period. This balances the load out over a longer time period and helps to prevent load spikes. You can set the maximum delay in seconds with this variable | | `1800` (30 minutes) |
| `require_ac_power` | If set to `true`, skip the backup when the host is not connected to AC power. | | `false` |
| `harden` | Whether to tighten security on the systemd service to prevent exploits as root. Can cause issues with hooks and other integrations | | `false` |
| `persistent` | Whether to immoderately run the backup job if the host "missed" its last run (the random delay still applies) | | `false` |
| `wakeup` | Whether to wake the system for the backup job if it is in standby. May or may not be supported | | `false` |


### Scheduling The Separate Check Job

On larger repositories, checks may take a very long time to complete.
This role can setup a separate check timer that runs independently of the backup job if you want to avoid your backups taking much longer than needed.

The timer job can be configured to perform one or more of the following actions: `repository`, `archives`, `data` (implies archive), `extract`.
Please see the [borg documentation](https://borgbackup.readthedocs.io/en/stable/usage/check.html) for more information about these options.

---
**NOTE**

Make sure that the check and backup job timers don't run at the same time! If they do, it is very likely that one of them will fail due to a missing lock on the borg repository.

---

Note that the values configured in [Schedule settings](#schedule-settings) will affect the check job (except for `backup` time of course).

##### `borgmatic_schedule_check_job`
- Whether to enable or disable the separate check job
- Default: `false`

##### `borgmatic_schedule_check_job_time`
- [systemd time expression](https://www.freedesktop.org/software/systemd/man/systemd.time.html) defining when the job should run
- Make sure this time is far enough apart from the backup job to prevent errors due to conflict locks.
- Default: `Mon 12:00`

##### `borgmatic_schedule_check_job_checks`
- List of checks to run (see above)
- Default: `['repository', 'archive']`

## Example Playbooks

```yaml
- hosts: all
  roles:
    - role: maxhoesel.borgbackup.borgmatic
      become: yes
      vars:
        # Always Required*Most parameters
        borgmatic_location_source_directories:
          - /home
          - /etc
          - /var
        # Always Required
        borgmatic_location_repositories:
          - borg@remote-backup-server.my.domain:{fqdn}
        # Required if borgmatic_init_repos is set to true (default)
        borgmatic_storage_encryption_passphrase: "mysupersecretpassphrase"
        # At least one retention_keep_ parameter is required
        borgmatic_retention_keep_daily: 5
```
